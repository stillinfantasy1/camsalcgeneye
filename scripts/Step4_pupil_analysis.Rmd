---
title: "Step3_preproc"
author: "zihan bai"
date: "2023-12-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Load necessary packages
```{r }
# install.packages("pacman)
library(pacman)
p_load(readr, dplyr, ggplot2, PupillometryR, PupilPre, shiny, tidyverse, stringr, emmeans, sjPlot, nlme, patchwork, purrr, ggpubr, lme4,PMCMRplus, stats)
```
# Paths
```{r}
# If work on Mac
base_path <- "/Users/bai/Library/CloudStorage/Box-Box/CAMSLab_Projects/Studies/AlcGen/Data/In_Lab"

# If work on Windows
# base_path <- "C:/Users/Zihan/Box/CAMSLab_Projects/Studies/AlcGen/Data/In_Lab"

# Input
preproc_path <- file.path(base_path, "pupillometry", "preprocessed")
preprocessed_cond_cs_path <- file.path(preproc_path, 'pupil_size', paste0('preprocessed_cond_cs.RData'))

# Load existing preprocessed data if it exists
if (file.exists(preprocessed_cond_cs_path)) {
  load(preprocessed_cond_cs_path)
}

# Which subjects?
subjects <- c('L003', 'L004', 'L006', 'L007', 'L009', 'L020', 'L021', 'H001', 'L022', 'L024', 'L026', 'L027', 'L028', 'L029')

excl_subjects <- c('L025')

# In what sample rate?
s_rate_500 <- c('L003', 'L004', 'L006', 'L007', 'L009', 'L020', 'L021', 'H001')
s_rate_250 <- c('L013', 'L014', 'L015', 'L017', 'L019', 'H002', 'H003')
s_rate_1000 <- c('L025', 'L031')

```
# Conditioning
## Load behavior data
```{r}
# Load behavioral data
behav_fname <- paste0(base_path, "/", "processed_behav", "/", "combined_conditioning_data.csv")
behav_cond <- read_csv(behav_fname)
recode_behav_cond <- behav_cond %>%
  rename(trial = trial_num,
         subject = subId) %>%
  mutate(incong_loc = case_when(
          trial_cat %in% c("alc_null_surprise", "null_alc_surprise", 
                          "null_neut_surprise", "neut_null_surprise") ~ 'NOTHING',
          # ignore 30% trials while congruent locs contain nothing
          # so each cs is reinforced with the same us location in 70% of trials
          # and with the same us image in 85% of trials
          stim == 'null' ~ 'NOTHING',
          TRUE ~ as.character(incong_loc))) %>%
  filter(subject %in% subjects) %>%
  select(c(subject, phase, trial, incong_loc, stim, iter, drink_2grp))
```
## Combine behavior and pupil
```{r}
combined_cond_cs <- left_join(processed_data, recode_behav_cond, by = c("subject", "trial", "stim"))

combined_cond_cs$subject <- as.factor(combined_cond_cs$subject)
combined_cond_cs$time <- as.numeric(as.character(combined_cond_cs$time))
aggregate(ps_cor ~ stim, data = combined_cond_cs, mean)
aggregate(ps_cor ~ time, data = combined_cond_cs, mean)

table(combined_cond_cs$incong_loc)
summary(combined_cond_cs$iter)
table(combined_cond_cs$drink_2grp)

anova_result <- aov(ps_cor ~ stim + Error(subject/trial), data = combined_cond_cs)
summary(anova_result)



# Quick check to ensure row counts are as expected
nrow(combined_cond_cs)
nrow(processed_data)
```


## CS onset
### Pupil response after cs onset by stimulus-type
```{r} 
# For an aggregate view across subjects to highlight general trends rather than individual variations, we calcualte the mean size at each time point for each condition. This provides a representation of how the average pupil dilation changes over time in response to each stimulus type.

# Time-course
trace_plot_cond_cs <- combined_cond_cs %>%
  filter(subject!="H001",
         stim %in% c("alc", "neut", "null")) %>%
  group_by(time, stim) %>%
  summarise(avg_ps = mean(ps_cor, na.rm = TRUE))

trace_plot_cond_cs$time <- as.numeric(as.character(trace_plot_cond_cs$time))

ggplot(trace_plot_cond_cs, aes(x = time, y = avg_ps, color = stim)) +
  geom_line() +
  #geom_smooth(aes(fill = stim), method = "loess", se = TRUE, alpha = 0.2, color = NA) +
  labs(title = "Pupil dilation in response to CS presentation",
       x = "Time (s)",
       y = "Pupul dilation",
       color = "US") + 
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = 1.8, linetype = "dashed", color = "grey") +
  scale_color_manual(values = c("alc" = "#A06593", "neut" = "#6086C5", "null" = "grey")) +
  theme_classic()
```
### Window analysis
```{r}
# In contrast, we calculate the mean pupil changes for each condition for each subject and controls for the individual differences among subjects
start_window <- 0.5
end_window <- 1.8

win_cond_cs <- combined_cond_cs %>%
  filter(time >= start_window & time <= end_window,
         subject!="H001",
         stim %in% c("alc", "neut", "null")) %>%
  group_by(subject, trial, stim) %>%
  summarize(win_avg = mean(ps_cor, na.rm = TRUE))

ggplot(win_cond_cs, aes(x = stim, y = win_avg, fill = stim)) +
  geom_boxplot() +
  labs(x = "US",
       y = "Mean pupil dilation",
       fill = "US") + 
  scale_fill_manual(values = c("alc" = "#A06593", "neut" = "#6086C5", "null" = "grey")) +
  theme_classic()

anova_result <- aov(win_avg ~ stim, data = win_cond_cs)
summary(anova_result)
```
### Within-subject pupil changes by condition
```{r}
subject_condition_averages <- win_cond_cs %>%
  group_by(subject, stim) %>%
  summarise(mean_ps_cor = mean(win_avg, na.rm = TRUE))

ggplot(subject_condition_averages, aes(x = stim, y = mean_ps_cor, group = subject)) +
  geom_line(aes(color = subject), show.legend = FALSE) + # Connects points with lines for each subject
  geom_point(aes(color = subject)) + # Plots the actual points
  labs(title = "Within-subject pupil size across conditions",
       x = "CS",
       y = "Mean pupil size") +
  theme_minimal() +
  scale_color_viridis_d() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
group_avg_cond_cs_split <- combined_cond_cs %>%
  filter(subject!="H001") %>%
  mutate(split = case_when(iter<=20 ~ "firstH", iter>20 ~ "secondH")) %>%
  group_by(split, time, stim) %>%
  summarise(avg_ps = mean(ps_cor, na.rm = TRUE),
            se = sd(ps_cor, na.rm = TRUE) / sqrt(n()), # Calculate standard error
            .groups = 'drop')
ggplot(group_avg_cond_cs_split, aes(x = time, y = avg_ps, color = stim)) +
  geom_line() +
  facet_wrap(~split) +
  labs(title = "Pupil dilation in response to CS presentation",
       x = "Time (s)",
       y = "Pupul dilation",
       color = "US") + 
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = 1.8, linetype = "dashed", color = "grey") +
  scale_color_manual(values = c("alc" = "#A06593", "neut" = "#6086C5", "null" = "grey")) +
  theme_classic()
```

```{r}
win_cond_cs_slit <- combined_cond_cs %>%
  filter(time >= start_window & time <= end_window,
         subject!="H001") %>%
  mutate(split = case_when(iter<=20 ~ "firstH", iter>20 ~ "secondH")) %>%
  group_by(split,stim) %>%
  summarize(win_avg = mean(ps_cor, na.rm = TRUE)) %>%
  ungroup()

ggplot(win_cond_cs_split, aes(x = stim, y = win_avg, fill = split)) +
  geom_boxplot() +
  labs(x = "US",
       y = "Pupil dilation",
       color = "US") + 
  scale_fill_manual(values = c("firstF" = "#1b9e77", "secondF" = "#d95f02"))+
  theme_classic()
```

```{r}
pdf(file = 'P_trace_plot.pdf', width = 4, height = 4, useDingbats = F)
print(P_trace_plot)
dev.off()
```


```{r}
pdf(file = 'P_win_cs.pdf', width = 4, height = 4, useDingbats = F)
print(P_win_cs)
dev.off()

anova_result <- aov(win_avg ~ stim, data = win_cond_cs)
summary(anova_result)
```


### Statistical Analysis
```{r}
# the effects of stimulus type, drinking level, and repetition on pupil dilation.
model_aov <- aov(mean_ps ~ stim, data = group_avg_cond_cs)
summary(model_aov)

# Model pupil size as a function of stimulus type, drinking level, and repetition, including random effects for subject
model <- lmer(ps ~ stim + (1 | subject), data = combined_cond_cs)

summary(model)
```
### Repetition
``` {r}
# divide into iterations
cond_cs_iter <- processed_data %>%
  filter(time>=start_window, time<=end_window) %>%
  group_by(subject, stim, iter) %>%
  summarize(avg_ps = mean(ps_cor, na.rm = TRUE)) %>%
  ungroup()


# lm
lm_cond_cs <- lme(avg_ps ~ stim * iter, random=~1|subject, data = cond_cs_iter)
anova_results <- anova(lm_cond_cs)
print(anova_results)
  
plot_model(lm_cond_cs, type = "eff", terms = c("iter", "stim"), axis.title = c("Repetition", "Pupil dilation")) +
  scale_color_manual(values = c("alc" = "#A06593", "neut" = "#6086C5", "null" = "grey")) +
  theme_classic()
```
```{r}
cond_cs_quar <- combined_cond_cs %>%
  group_by(subject, stim, iter) %>%
  mutate(quartile = ntile(iter, 4)) %>%
  ungroup() %>%
  group_by(subject, stim, quartile) %>%
  summarize(avg_ps = mean(ps, na.rm = TRUE)) %>%
  ungroup()

ggplot(cond_cs_quar, aes(x = quartile, y = avg_ps, color = stim)) +
  geom_point() +
  geom_smooth(method = "loess", formula = y ~ x, se = FALSE) +
  scale_color_manual(values = c("alc" = "#A06593", "neut" = "#6086C5", "null" = "grey")) +
  theme_classic()
```


## Anticipation gaze
```{r}
rm(list = ls())
# Which subjects?
subjects <- c('L003', 'L004', 'L006', 'L007', 'L009', 'L020')

# In what sample rate?
s_rate_500 <- c('L003', 'L004', 'L006', 'L007', 'L009', 'L020', 'L021', 'H001')
s_rate_250 <- c('L013', 'L014', 'L015', 'L017', 'L019', 'H002', 'H003')

# Define paths
base_path <- "/Users/bai/Library/CloudStorage/Box-Box/CAMSLab_Projects/Studies/AlcGen/Data/In_Lab"

output_gaze_path <- file.path(base_path, "pupillometry", "preprocessed", "gaze")
if (!dir.exists(output_gaze_path)) {
  dir.create(output_gaze_path)
}

gaze_cond_base_path <- file.path(output_gaze_path, "gaze_cond_baseline.RData")
gaze_cond_base <- list()
if (file.exists(gaze_cond_base_path)) {
  load(gaze_cond_base_path)
}

gaze_cond_ant_path <- file.path(output_gaze_path, "gaze_cond_ant.RData")
gaze_cond_ant <- list()
if (file.exists(gaze_cond_ant_path)) {
  load(gaze_cond_ant_path)
}
```

```{r}
for (subject in subjects) {
  ant_input_path <- file.path(base_path, "pupillometry", "restructured", "trial_split", subject, paste0(subject, "_cond_ant.RData"))
  fix_input_path <- file.path(base_path, "pupillometry", "restructured", "trial_split", subject, paste0(subject, "_cond_fix.RData"))
  
  cond_gaze <- load(ant_input_path)
  ant <- ant %>%
    filter(!is.na(incong_loc)) %>%
    rename(trial = trial_num) %>%
    group_by(trial) %>%
    mutate(time_adj = row_number(),
           time = (time_adj - 1) / 1000 * 2) %>%
    ungroup() %>%
    select(subject, time, xp, yp, ps, trial, stim, incong_loc, us_loc, choice, surprise_us)
  
  # # identify a window that closely approximates the central fixation point on a visual display, while simultaneously ensuring that the data from all trials remain within the usable range.
  left_bound <- 807.37
  right_bound <- 1133.62
  center_fixation <- (right_bound + left_bound) / 2
  base_threshold <- 160 # test
  base_left <- center_fixation - base_threshold
  base_right <- center_fixation + base_threshold

  # # apply the threshold
  # # fixation as baseline
  cond_fix <- load(fix_input_path)
  fix <- fix %>%
    filter(!is.na(incong_loc),
           between(xp, base_left, base_right)) %>%
    rename(trial = trial_num) %>%
    group_by(trial) %>%
    mutate(time = row_number()) %>%
    summarize(fix_median = median(xp, na.rm = TRUE)) %>%
    ungroup() %>%
    select(trial, fix_median)

  # gaze_cond_base[[subject]] <- fix

  # # merge the baseline and anticipation
  ant_corr <- ant %>%
    left_join(fix, by = "trial")
  
  # compute median during anticipation
  ant_median <- ant_corr %>%
    group_by(trial) %>%
    mutate(time = row_number()) %>%
    summarize(ant_median = median(xp, na.rm = TRUE)) 
  
  ant_corr <- ant_corr %>%
    left_join(ant_median, by = "trial")
  
  # # define midpoints of target regions
  # x_ROI = c(337.365, 663.615, center_fixation, 1277.37, 1603.62)
  # left_ROI_midpoint = (x_ROI[1] + x_ROI[2]) / 2
  # right_ROI_midpoint = (x_ROI[4] + x_ROI[5]) / 2
  
  # normalize gaze x to the baseline median
  # loc_opts = c("left", "right")
  
  
  
  ant_norm <- ant_corr %>%
    # figure out expected position of US
    mutate(expect_loc = ifelse(stim == "null", "none",
                               ifelse(incong_loc == "FALSE", us_loc,
                                      ifelse(us_loc=="right", "left",
                                             ifelse(us_loc=="left", "right", NA))))) %>%
    mutate(xp_norm.fix = 100 * (xp - fix_median) / fix_median,
           xp_norm.ant = xp - ant_median,   # positive = right, negative = left
           towardness.fix = ifelse(expect_loc=="left", -1 * xp_norm.fix, 
                               ifelse(expect_loc=="right", xp_norm.fix,
                                           ifelse(expect_loc == "none", NA, NA))),
           towardness.ant = ifelse(expect_loc=="left", -1 * xp_norm.ant, 
                               ifelse(expect_loc=="right", xp_norm.ant,
                                           ifelse(expect_loc == "none", NA, NA)))
           )
  gaze_cond_ant[[subject]] <- ant_norm
}



# # pos = right, neg = left
#     mutate(xp_norm = 100 * (xp - fix_median) / fix_median,
#            towardness = ifelse(expect_loc=="right", xp_norm - right_ROI_midpoint,
#                                     ifelse(expect_loc=="left", xp_norm - left_ROI_midpoint,
#                                            ifelse(expect_loc == "none", xp_norm, NA))))
# save(gaze_cond_ant, file = gaze_cond_ant_path)
#save(gaze_cond_base, file = gaze_cond_base_path)
```

```{r}
twd_cond <- load(gaze_cond_ant_path)
twd_cond_all <- bind_rows(gaze_cond_ant)

# By normalzing the gaze position by the median gaze position during anticipation (rather than fixation), the number of positive and negative values of normalized gaze position has to be the same, or nearly the same, considering .
sanity_check_twd <- twd_cond_all %>%
  group_by(subject, trial) %>%
  summarize(pos = sum(xp_norm.ant > 0, na.rm = TRUE),
            neg = sum(xp_norm.ant < 0, na.rm = TRUE),
            counts_equal = pos == neg,
            deviation = ifelse(counts_equal, 0, abs(pos - neg))) %>%
  ungroup()
describe(sanity_check_twd$deviation)

twd_cond_all_exclusion <- twd_cond_all %>%
  left_join(sanity_check_twd, by = c("subject", "trial")) %>%
  filter(deviation <10)

# Visualize
# Before excluding trials whose deviation between pos and neg is higher than 10
ggplot(twd_cond_all %>% filter(stim != "null"), aes(x = time, y = towardness.ant, color = stim)) +
  geom_smooth(se = FALSE) + theme_classic() + geom_hline(yintercept = 0)

# After
ggplot(twd_cond_all_exclusion %>% filter(stim != "null"), aes(x = time, y = towardness.ant, color = stim)) +
  geom_smooth(se = FALSE) + theme_classic() + geom_hline(yintercept = 0)
 
# Within-subjects?
ggplot(twd_cond_all %>% filter(stim != "null"), aes(x = time, y = xp_norm.ant, color = expect_loc)) +
  facet_wrap(~subject) +
  geom_smooth(se = FALSE) + theme_classic() + geom_hline(yintercept = 0)

# side bias?
ggplot(twd_cond_all %>% filter(stim == "null"), aes(x = time, y = towardness, color = stim)) + geom_smooth(se = FALSE) + theme_classic() + geom_hline(yintercept = 0)
  
# look for reaction time for alc and neut because the time they take to move to the expected location seems different?

```



# US onset
```{r}
merged_us <- list()

for (subid in names(preprocData_us)) {
  # Current pupil dataframe
  subj_pupil <- preprocData_us[[subid]]
  
  # Filter for the current subject only
  subj_behav <- behav_cond %>% filter(subject == subid)
  
  # Merge
  subj_merged <- left_join(subj_pupil, subj_behav, by = c('subject', 'trial'))
  
  # Store into the list
  merged_us[[subid]] <- subj_merged 
}

# Combine all into a single dataframe
merged_us_df <- bind_rows(merged_us, .id = 'subject')
```

#### Pupil response after us onset by stimulus-type
```{r}
# Time-course
ggplot(merged_us_df, aes(x = time, y = ps_cor, group = stim, color = stim)) +
  stat_summary(fun = mean, geom = "line", na.rm = TRUE) +
  theme_minimal()

# Window analyses
# Window of interest (0.5-1.8s)
window_start = 0.5
window_end = 1.8
combined_us_window <- filter(merged_us_df, between(time, window_start, window_end))
us_window <- create_window_data(combined_us_window, pupil = ps_cor)
plot(us_window, pupil = ps_cor, windows = F, geom = 'boxplot')

```
## Generalization
### GS onset
```{r}
# Load pupil from Step 3
load('/Users/bai/Library/CloudStorage/Box-Box/CAMSLab_Projects/Studies/AlcGen/Data/In_Lab/pupillometry/preprocessed/gen_gs.RData')

# Load behavior in generalization task
behav_fname <- paste0(base_path, "/", "processed_behav", "/", "combined_generalization_data.csv")
  behav_gen <- read_csv(behav_fname)
  behav_gen <- behav_gen %>%
    filter(block != 'prac') %>%
    select(-c(anticipation_onset, anticipation_offset, gs_presentation_onset, cs_presentation_onset, cs_presentation_offset)) %>%
    rename(trial = trial_num,
           subject = subId,
           diss = gs_deg) %>%
    select(subject, phase, trial, diss, drink_2grp)
  
# for looking at trace plots in generalization - diff rows per CS type, diff trace plots on each 
alc_cs = list(deg0 = rnorm(100), deg10 = rnorm(100), deg20 = rnorm(100))
neut_cs = list(deg0 = rnorm(100), deg10 = rnorm(100), deg20 = rnorm(100))

alc_cs.df <- alc_cs %>% as.data.frame() %>% mutate(cs_type = "alc", timing = c(1:100))
neut_cs.df <- neut_cs %>% as.data.frame() %>% mutate(cs_type = "neut", timing = c(1:100))

mult_cs.df <- rbind(alc_cs.df, neut_cs.df)

mult_cs.df %>% 
  pivot_longer(c(1:3), values_to = "pupil_area", names_to = "deg") %>%
  ggplot(aes(x = timing, y = pupil_area, color = deg)) +
  geom_line() +
  facet_grid(cs_type~.) +
  theme_classic()

  
```

```{r}
merged_gs <- list()

for (subid in names(preprocData_gs)) {
  # Current pupil dataframe
  subj_pupil <- preprocData_gs[[subid]]
  
  # Filter for the current subject only
  subj_behav <- behav_gen %>% filter(subject == subid)
  
  # Merge
  subj_merged <- left_join(subj_pupil, subj_behav, by = c('subject', 'trial'))
  
  # Store into the list
  merged_gs[[subid]] <- subj_merged 
}

# Combine all into a single dataframe
merged_gs_df <- bind_rows(merged_gs, .id = 'subject')
```

#### Pupil response after gs onset by stimulus-type
```{r}
# Time-course
ggplot(merged_gs_df, aes(x = time, y = ps_cor, group = trial_cat, color = trial_cat)) +
  stat_summary(fun = mean, geom = "line", na.rm = TRUE) +

  theme_minimal()

# Window analyses
# Window of interest (0.5-1.8s)
window_start = 0.5
window_end = 1.8
combined_gs_window <- filter(merged_gs_df, between(time, window_start, window_end))
gs_window <- create_window_data(combined_gs_window, pupil = ps_cor)
plot(gs_window, pupil = ps_cor, windows = F, geom = 'boxplot')

```
